---
title: |
  ![](https://coes.cl/wp-content/uploads/COES_Logo_sello1.png){width=25% height=25%}  
  Exploratory analysis - DV's
author: 
  - Techinical assistant
date: "`r format(Sys.Date(), '%d/%m/%Y')`"
output:
    bookdown::html_document2:
          theme: yeti
          toc: yes
          toc_float: yes
          toc_collapsed: yes
          number_sections: yes
          
          
    
linkcolor: black
urlcolor: blue
execute:
  echo: false
  warning: false
---

```{=html}
<style type="text/css">

h1, {
  font-size: 38px;
  text-align: center;
}
h4.author { /* Header 4 - and the author and data headers use this too  */
    font-size: 18px;
  text-align: center;
}
h4.date { /* Header 4 - and the author and data headers use this too  */
  font-size: 18px;
  text-align: center;
}
</style>
```
```{r include=FALSE}
## Load packages

if (!require("pacman")) {
    install.packages("pacman")
} # si falta pacman, instalar

pacman::p_load(
    tidyverse,
    haven,
    data.table,
    sjmisc,
    knitr,
    lavaan,
    kableExtra,
    effectsize,
    psych,
    poLCA
) # librerias
```

```{r}
# Load data
elsoc <- readRDS("../../input/data/proc/elsoc_proc.RDS")

# Create dataframes with dependent variables

z_varsdep <- elsoc %>% dplyr::select(starts_with("z_")) # Normalized
varsdep <- elsoc %>% dplyr::select(identification:justif_violence) # Normal

varsdep_rounded <- varsdep %>% mutate(
  across(names(varsdep), ~ round(.)),
  across(names(varsdep), ~ if_else(. == 0, . + 1, .))
) # Rounded (for LCA and MCA)

varsdep_rounded_factor <- varsdep_rounded %>%
  mutate(across(everything(), as.factor)) # Factors (for LCA)

```

```{r}

correlation <- function(data, labs, coef.size = 0.6){
  
  # Insumos
  cor.mtest <- function(mat, ...) {
    mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat<- matrix(NA, n, n)
    diag(p.mat) <- 0
    for (i in 1:(n - 1)) {
        for (j in (i + 1):n) {
            tmp <- cor.test(mat[, i], mat[, j], ...)
            p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
        }
    }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}
  
  M <- cor(data)
  colnames(M) <- labs
  rownames(M) <- labs

  p.mat <- cor.mtest(data)
  colnames(p.mat) <- labs
  rownames(p.mat) <- labs

  col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
  corrplot::corrplot(M, 
                   method="color", 
                   col=col(200),
                   type="upper",
                   addCoef.col = "#141414",
                   tl.col="#141414", 
                   tl.srt=45,
                   p.mat = p.mat, 
                   sig.level = 0.05, 
                   insig = "blank",
                   diag = TRUE,
                   number.cex = coef.size,
                   mar = c(0, 0, 1, 0),
                   number.digits = 2,
                   number.font = 1
                   )

}

labels <- c(
  "C - Ident.",
  "R - Amigos",
  "R - Tamaño red",
  "R - Conf. gen.",
  "R - Conf. min.",
  "R - Conf. inst.",
  "P - Int. pol.",
  "P - Satis. demo",
  "P - Part. conv.",
  "P - Part. no conv.",
  "P - Igualitarismo.",
  "P - Altruismo.",
  "P - Cond. prosoc.",
  "N - Apoyo demo.",
  "N - Just. viol."
)

C <- labels[1]
R <- labels[2:6]
P <- labels[7:13]
N <- labels[14:15]

# Function for columns spec

specific_col <- function(kbl, data, n, umbrale = 0.2){
      kableExtra::column_spec(kbl, n, 
                  color = dplyr::case_when(
                  as.matrix(data[,n]) > umbrale ~ "darkblue",
                  as.matrix(data[,n]) < -umbrale ~ "darkred",
                  TRUE ~ "lightgrey"
                  )
                )
}
```

```{r}

pca_loads_tab <- function(data, automatic.scale = FALSE, title) {
    pca <- prcomp(data, scale = automatic.scale)

    # Check loadings
    loads <- as.data.frame(unclass(pca$rotation)) %>%
        dplyr::mutate(
            across(everything(), ~ round(., 2)),
            vars = labels
        ) %>%
        dplyr::select(vars, 1:4)

    rownames(loads) <- 1:15


    loads %>%
        kable(caption = title) %>%
        kableExtra::kable_styling(
            bootstrap_options = c("striped", "hover", "condensed", "responsive"),
            full_width = T
        ) %>%
        row_spec(c(0, 1, 6, 13, 15), extra_css = "border-bottom: 2px solid gray;") %>%
        specific_col(data = loads, n = 2) %>%
        specific_col(data = loads, n = 3) %>%
        specific_col(data = loads, n = 4) %>%
        specific_col(data = loads, n = 5)
}


pca_var_tab <- function(data, automatic.scale, title){
  pca <- prcomp(data, scale = automatic.scale)
  
  var <- summary(pca)$importance %>% 
    as.data.frame() %>% 
    mutate(
      across(everything(), ~ round(., 2)),
      Statistic = rownames(.)
      ) %>% 
    dplyr::select(Statistic, 1:4)
  
  rownames(var) <- 1:3
  
  var %>%
        kable(caption = title) %>%
        kableExtra::kable_styling(
            bootstrap_options = c("striped", "hover", "condensed", "responsive"),
            full_width = T
        )
}

```

# Introduction

This document contains a Principal Component Analysis (PCA) to reduce the number of dependent variables. First, we perform a PCA using the normalized dependent variables. Second, we perform an Exploratory Factor Analysis (EFA) to compare the results with those of the previous analysis. Then, we perform two analyses assuming qualitative variables: LCA and MCA.

The results and assumptions for each case are discussed. Finally, a recommendation is made based on all the background information.

# Analysis

## Exploration

```{r}
#| fig-height: 10
#| fig-width: 10

correlation(z_varsdep, labels)
```

The correlation chart shows that most correlations are low. The highest correlation, with a positive coefficient of 0.44, occurs between indicators of different dimensions: institutional trust (relational) and satisfaction with democracy (political). The same is true of the relationship between trust in minorities and interest in politics or unconventional participation, both with a positive coefficient of 0.34. The highest correlations within the same dimension are in politics: 0.38 between interest in politics and unconventional participation and 0.32 between conventional and unconventional participation. Notably, the intradimensional correlations do not demonstrate consistent measurements.

::: panel-tabset
# Relational Dimention

```{r}
#| fig-height: 10
#| fig-width: 10

correlation(z_varsdep[, 2:6], R, 1)
```

# Political Dimention

```{r}
#| fig-height: 10
#| fig-width: 10

correlation(z_varsdep[, 7:13], P, 1.2)
```

# Normative Dimention

```{r}
#| fig-height: 10
#| fig-width: 10

correlation(z_varsdep[, 14:15], N, 1.5)
```
:::

Sí observamos los gráficos de correlación divididos por dimensión, es más notorio que los indicadores no correlacionan lo suficiente entre sí para aseverar que miden consistentemente un mismo constructo.

## PCA

```{r}
scree(z_varsdep)
```

The sedimentation graph shows that the first component explains more than twice the variance of an indicator alone. The following three factors meet Kaiser's criterion (eigenvalue \> 1) but explain considerably less variance. These results suggest that the optimal solution for reducing dimensionality is between one and four components, depending on the conceptual meaning of each solution.

```{r}
fa.parallel(z_varsdep, fa = "pc")
```

The parallel graph compares the observed data with a random dataset. This comparison confirms that the optimal solution lies between one and four components.

::: panel-tabset

# PCA Loadings (R's normalization)

```{r}
pca_loads_tab(varsdep, TRUE, "PCA Loadings (R's normalization)")
pca_var_tab(varsdep, TRUE, "Explained variance (R's normalization)")
```

# PCA Loadings (manual normalization)

```{r}
pca_loads_tab(z_varsdep, FALSE, "PCA Loadings (manual normalization)")
pca_var_tab(z_varsdep, FALSE, "Explained variance (manual normalization)")
```

# PCA Loadings (without normalization)

```{r}
pca_loads_tab(varsdep, FALSE, "PCA Loadings (without normalization)")
pca_var_tab(varsdep, FALSE, "Explained variance (PCA without normalization)")
```
:::

The PCA table with normalized variables from R shows that a four-component solution captures just over 40% of the variance. The first component captures only 17%, while the others capture approximately 10% each. These results indicate that the variables are poorly correlated with each other, making it difficult to reduce dimensionality. This finding is consistent with the correlation analyses, which revealed no significant correlations within the dimensions.

1.  **Active Political Engagement vs. Passive Institutional Support:** the first component is characterized by negative values in most indicators of the relational and political dimensions and positive values in the normative dimension, which is more pronounced in support of democracy. This reflects a pattern of people who are not very involved in politics or with their peers but who have a strong commitment to democratic norms (and vice versa).
2.  **Individualized traditional progressivism:** the second component is characterized by strong loads in institutional trust, satisfaction with democracy, and egalitarianism. This pattern denotes a strong commitment to traditional values of the rule of law, along with low nonconventional participation and network sizes (and vice versa).
3.  **Individualized altruism:** the third component is characterized by a strong emphasis on altruistic attitudes, rejection of violence and smaller network sizes (and vice versa).
4.  **Relativistic prosocial sociability:** the fourth component is characterized by strong loads on cultural and relational indicators, as well as prosocial behavior. However, it also highlights a positive association with justifying violence, indicating relativism when evaluating conflict situations.

## EFA

```{r}
fa.parallel(z_varsdep, fa = "fa")
```

The parallel analysis shows that a six-factor solution better represents the latent structure of the variables than a simulated dataset. However, it is important to note that, according to Kaiser's criterion, only the one-factor solution has the necessary eigenvalues. We explored solutions with one and four factors, the latter of which is based on the conceptual proposal behind measuring attachment to society.

```{r}
KMO(z_varsdep)
cortest.bartlett(z_varsdep)
```

According to the KMO criteria and Bartlett's sphericity test, the data meet the minimum requirements for testing a factor analysis.

::: panel-tabset
# 1 factor solution

```{r}
f1 <- factanal(z_varsdep, factors = 1, rotation = "varimax")$loadings %>% 
  unclass(.) %>% 
  as.data.frame(.) %>% 
  dplyr::mutate(across(everything(), ~round(., 2)), var = labels) %>% 
  dplyr::select(var, everything())

rownames(f1) <- 1:15

f1  %>%
        kable(caption = "EFA Loadings - 1 factor solution") %>%
        kableExtra::kable_styling(
            bootstrap_options = c("striped", "hover", "condensed", "responsive"),
            full_width = T
        ) %>%
        row_spec(c(0, 1, 6, 13, 15), extra_css = "border-bottom: 2px solid gray;") %>%
        specific_col(data = f1, n = 2, 0.4)
```

# 4 factor solution

```{r}
f4 <- factanal(z_varsdep, factors = 4, rotation = "varimax")$loadings %>% 
  unclass(.) %>% 
  as.data.frame(.) %>% 
  dplyr::mutate(across(everything(), ~round(., 2)), var = labels) %>% 
  dplyr::select(var, everything())

rownames(f4) <- 1:15


f4  %>%
        kable(caption = "EFA Loadings - 4 factor solution") %>%
        kableExtra::kable_styling(
            bootstrap_options = c("striped", "hover", "condensed", "responsive"),
            full_width = T
        ) %>%
        row_spec(c(0, 1, 6, 13, 15), extra_css = "border-bottom: 2px solid gray;") %>%
        specific_col(data = f4, n = 2, 0.4) %>%
        specific_col(data = f4, n = 3, 0.4) %>% 
        specific_col(data = f4, n = 4, 0.4) %>% 
        specific_col(data = f4, n = 5, 0.4)

```
:::

The 1-factor solution delivers results quite similar to PCA, where attachment to society is characterized by loadings on some of the indicators of the relational dimension and the political dimension. Specifically, this is reflected in indicators related to different types of political involvement and trust. This factor explains only about 12% of the variance.

The 4-factor solution follows a similar logic to PCA. The first factor represents a dimension of attachment to society related to unconventional political commitment and sociability. The second dimension is characterized by republican political values. The third dimension is related to prosocial attitudes, and the fourth is related to the cultural indicator. In any case, it is important to remember that, starting with the second factor, they explain less than one indicator alone.

# LCA

In addition to testing quantitative variables, we examined multivariate clustering techniques for categorical variables. Specifically, we examined Latent Class Analysis (LCA), which, like EFA, investigates the latent structure underlying the indicators. The main difference between LCA and EFA is that LCA assumes these latent structures are "classes" rather than continuous factors and models the probability of belonging to different classes.

We will use the variables in their original scales for LCA, most of which are ordinal. Many of these variables, however, were averaged because they considered two or more indicators of the same scale. Since the indicators used in LCA must be integers, we rounded the averages of these variables.

```{r}
varsdep_rounded <- varsdep %>% mutate(
  across(names(varsdep), ~ round(.)),
  across(names(varsdep), ~ if_else(. == 0, . + 1, .))
)
```

```{r, results='asis'}
summarytools::dfSummary(varsdep_rounded,plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.82, 
          varnumbers   = FALSE,
          valid.col    = FALSE,
          tmp.img.dir  = "/tmp")
```

Once the variables have been rounded, we proceed to apply LCA:

```{r}
f <- cbind(
  identification, friends, size_network,
  gen_trust, trust_minorities, trust_inst,
  interest_pol, satisf_demo, conv_particip,
  unconv_particip, egalitarianism, altruistic,
  prosoc_behave, democracy_support, justif_violence
) ~ 1


lca <- poLCA(f, varsdep_rounded, nclass = 2, verbose = F)$probs %>%
    map(., as.data.frame)
  
lca$gen_trust <- lca$gen_trust %>%
    mutate("Pr(4)" = NA, "Pr(5)" = NA)
  
lca$conv_particip <- lca$conv_particip %>%
    mutate("Pr(4)" = NA, "Pr(5)" = NA)
  
lca$prosoc_behave <- lca$prosoc_behave %>%
    mutate("Pr(4)" = NA, "Pr(5)" = NA)
  
lca$democracy_support <- lca$democracy_support %>%
    mutate("Pr(5)" = NA)

lca_tab <- bind_rows(lca)
rownames(lca_tab) <- 1:30

lca_tab <- lca_tab %>% 
  mutate(
  across(everything(), ~round(., 2)),
  class = rep(c("class 1", "class 2"), 15),
  var =  rep(labels, each = 2)
) %>% 
  dplyr::select(var, class, everything())


lca_tab_wide <- lca_tab %>%
  pivot_longer(
    cols = starts_with("Pr("),
    names_to = "category",
    values_to = "prob"
  ) %>%
  pivot_wider(
    names_from = class,
    values_from = prob
  )


lca_tab_wide %>%
        kable(caption = "LCA Belongings - 2 classes") %>%
        kableExtra::kable_styling(
            bootstrap_options = c("striped", "hover", "condensed", "responsive"),
            full_width = T
        ) %>%
        row_spec(c(0, 5, 30, 65, 75), extra_css = "border-bottom: 2px solid gray;") %>%
        specific_col(data = lca_tab_wide, n = 3, 0.4) %>%
        specific_col(data = lca_tab_wide, n = 4, 0.4) 
```

# Synthesis
